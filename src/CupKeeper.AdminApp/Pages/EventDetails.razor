@page "/events/{eventId:guid}"
@using CupKeeper.AdminApp.Components
@using CupKeeper.AdminApp.Services
@using CupKeeper.Domains.Championships.ViewModel
@inject EventService EventService;
<PageTitle>@_event.Name - Event Details - Cup Keeper</PageTitle>

<div class="mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <Toolbar Title=@($"Event: {_event.Name}") Subtitle="We do some eventing here."/>

    <div>Grid of info goes here...</div>

    @* <CourseSelector /> *@
    <Toolbar Title="Results">
        <Buttons>
            <Button Type="ButtonType.Primary" Clicked=@LoadResultsFromUsac Disabled=@_isLoadingResults>
                @if (_isLoadingResults)
                {
                    <Spinner/>
                }
                else
                {
                    @HeroIcons.ArrowRightOnRectangle("inline-block")
                }
                <span>Load Results</span>
            </Button>
        </Buttons>
    </Toolbar>
    @* <DataGrid Items="_events" Columns="_columns" HideToolbar /> *@
    @foreach (var category in _event.Results)
    {
        <div class="my-3 rounded bg-gray-800 p-3">
            <Toolbar Title=@category.Name />
            
            <DataGrid HideToolbar Items="category.Riders.OrderBy(m => m.Place)" Columns="_categoryColumns" />
            
            @if (category.ExcludedRiders.Any())
            {
                <h2 class="text-xl mb-0">
                    Excluded Results
                </h2>

                <DataGrid HideToolbar Items="category.ExcludedRiders" Columns="_categoryColumns"/>
            }
        </div>
    }
</div>


@code {
    [Parameter] public Guid EventId { get; set; }

    [CascadingParameter(Name = "Theme")] public ITheme Theme { get; set; } = null!;

    private EventViewModel _event = new();
    private bool _isLoadingResults = false;

    private Timer? _loadTimer;

    private IEnumerable<Column<RiderResultViewModel>> _categoryColumns =
    [
        new Column<RiderResultViewModel>() { Title = "Place", Field = m => m.Place, Component = typeof(RiderPlacementColumn) },
        new Column<RiderResultViewModel>() { Title = "Points", Field = m => m.Points },
        new Column<RiderResultViewModel>() { Title = "Rider", Field = m => m.RiderName },
        new Column<RiderResultViewModel>() { Title = "Team", Field = m => m.TeamName },
        new Column<RiderResultViewModel>() { Title = "Time", Field = m => m.Time, Component = typeof(RiderTimeColumn) }
    ];

    private async Task LoadResultsFromUsac()
    {
        _isLoadingResults = true;

        var response = await EventService.StartLoad(EventId);

        if (response)
        {
            _loadTimer = new Timer(CheckResultsAsync, new { }, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(1));

            StateHasChanged();
        }
    }

    private async void CheckResultsAsync(object? state)
    {
        var isFinished = await EventService.CheckLoadStatus(EventId);

        if (isFinished)
        {
            _event = (await EventService.GetEvents()).First(m => m.Id == EventId);
            _isLoadingResults = false;

            if (_loadTimer is not null)
            {
                await _loadTimer.DisposeAsync();
                _loadTimer = null;
            }
            
            StateHasChanged();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        _event = (await EventService.GetEvents()).First(m => m.Id == EventId);
    }

}